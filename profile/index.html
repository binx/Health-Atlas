<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="lib/jquery.min.js" charset="utf-8"></script>
        <script type="text/javascript" src="lib/d3.v3.min.js" charset="utf-8"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <div id="map">
            <h1></h1>
            <svg></svg>
            <div id="pop-stats">
                <h3>Total Population:</h3>
                <p class="pop-total"><span></span></p>
                <h3>Population Density:</h3>
                <p class="pop-density"><span></span> sq mile</p>
                <h3>Population Age</h3>
                <p class="pop-under-5">under 5: <span></span></p>
                <p class="pop-under-18">under 18: <span></span></p>
                <p class="pop-over-65">over 65: <span></span></p>
				<h3>Race & Ethnicity</h3>
                <p class="pop-non-white" >non-white: <span></span></p>
                <p class="pop-isolated">linguistically isolated: <span></span></p>
            </div>
            <div id="map-annotation"></div>
            <div id="color-key">
                <div class="title">Color Key</div>
                <div class="color-bar"></div>
                <div class="avg-bar" width="100%" height="20px"></div>
                <div class="labels">
                    <div class="low">low</div>
                    <div class="avg">average</div>
                    <div class="high">high</div>
                </div>
            </div>
            <div id="tooltip">
                <div class="title">More Information</div>
                <div class="prompt">Click on a statistic to learn more.</div>
                <div class="attr"></div>
                <ul>
                    <li class="avg">City of Los Angeles: <span></span></li>
                </ul>
                <div class="desc"></div>
            </div>
        </div>
        <div id="graphs"></div>
    </body>
    <script type="text/javascript">
        var specialRows = ["DataSource","Description","MinimumValue","MaximumValue","AverageValue","GeographicScale","AveValueGeo","ShortLabel","Source","Date"];
        var colors = ["#69BA0F","#45C0E7","#F5AC2D","#BE87A1","#DB3C00","#F5D700","#AC7A4D"],
            quartileColors = ["#F07221","#E19A79","#c7cccf","#89BBD3","#55A4DB"];
        var graphs = d3.select("#graphs"),
            map = d3.select("#map"),
            tooltip = $("#tooltip"),
            areaName,
            areaData = {},
            mapData = {};

        var layoutData;

        d3.json("geo_data/profile.json",function(json){
            layoutData = json.data;
   			var i=0;
            json.data.forEach(function(v){
             	i++;
				var category ="section-"+i;
                var div = graphs.append("div").attr("class",category);
                div.append("h1").text(v.key);
                var graphWrapper = div.append("div").attr("class","graph-wrapper");

                v.obj.forEach(function(w){
                    var subdiv = graphWrapper.append("div").attr("class","graph graph-"+w.obj.type).data([w.obj]);
                    if (w.key) subdiv.append("h2").text(w.key);
                });
            });
            $("#graphs h1").click(function(){
                $(this).parent().find(".graph-wrapper").slideToggle();
            })
            loadDataSource(1, 0);
        });

        var dataSources = ["CPA","CD","HD","PUMA","ZIP"];

        function loadDataSource(id, i) {
            var source = dataSources[i];

            d3.csv("data/"+id+"-"+source+".csv",function(csv){
                if (source == "CPA") areaName = csv[0]["Area Name"];
                areaData[source] = {};

                csv.forEach(function(v,i){
                    if (v["Area Name"] != "") {
                        if (v["Specific area"] != "")
                            areaData[source][v["Specific area"]] = v;
                        else
                            areaData[source][v["Area Name"]] = v;
                    }
                });

                if (i < dataSources.length-1) loadDataSource(id, i+1);
                else showData();
            });
        }

        var loaded = false;

        function showData() {
            map.select("h1").text(areaName);

            if (loaded) {
                graphs.selectAll(".graph").each(function(d){ 
                    var source = d.source, 
                        type = d.type, 
                        div = d3.select(this), 
                        notes = (d.notes) ? d.notes : "";

                    switch (d.type) {
                        case "thermometer":
                            var attr = d.data[0];
                            updateThermometer(attr, areaData[source][areaName][attr], areaData[source]["MinimumValue"][attr], areaData[source]["MaximumValue"][attr], areaData[source][areaName][attr+"-FORMAT"], div, notes.number);
                            break;
                        case "pie":
                            var attr = d.data[0];
                            updatePie(areaData[source][areaName][attr], areaData[source]["AverageValue"][attr], areaData[source]["MinimumValue"][attr], areaData[source]["MaximumValue"][attr], attr, div);
                            break;
                        case "stemandleaf":
                            updateStemAndLeaf(d.data,areaData[source][areaName],areaData[source]["AverageValue"],areaData[source]["MinimumValue"],areaData[source]["MaximumValue"], div);
                            break;
                        case "waffle":
                            updateWaffle(areaData[source][areaName], areaData[source]["Description"], d.data, div);
                            break;
                        case "isotype":
                            updateIsotype(areaData[source][areaName],areaData[source]["MinimumValue"],areaData[source]["MaximumValue"], div, d.data);
                            break;
                        case "barchart":
                            var dataAggregate = processBarData(d.data, source);
                            updateBars(dataAggregate, source, div, notes.showLabels);
                            break;
                        case "bubble":
                            var dataAggregate = processBarData(d.data, source);
                            updateBubbles(dataAggregate, source, div);
                            break;
                        case "multistem":
                            var dataAggregate = processBarData(d.data, source);
                            updateMultiStem(dataAggregate, source, div);
                            break;
                    }
                });
            } else {
                graphs.selectAll(".graph").each(function(d){ 
                    appendGraph(d.source, d.type, d.data, d3.select(this), (d.notes ? d.notes : ""));
                });
            }
            populatePopStats();

            loaded = true;

            loadMap();
        }

        function appendGraph(source, type, data, div, notes) {
            switch (type) {
                case "waffle":
                    drawWaffle(areaData[source][areaName], areaData[source]["Description"], data, div);
                    break;
                case "isotype":
                    drawIsotype(areaData[source][areaName],areaData[source]["AverageValue"],areaData[source]["MinimumValue"],areaData[source]["MaximumValue"],areaData[source]["Description"], data, div);
                    break;
                case "thermometer":
                    var attr = data[0];
                    drawThermometer(attr, areaData[source][areaName][attr], areaData[source]["MinimumValue"][attr], areaData[source]["MaximumValue"][attr], areaData[source][areaName][attr+"-FORMAT"], div, notes.number, notes.wordDesc);
                    break;
                case "stemandleaf":
                    drawStemAndLeaf(data,areaData[source][areaName],areaData[source]["AverageValue"],areaData[source]["MinimumValue"],areaData[source]["MaximumValue"], div);
                    break;
                case "pie":
                    var attr = data[0];
                    drawPie(areaData[source][areaName][attr], areaData[source]["AverageValue"][attr], areaData[source]["MinimumValue"][attr], areaData[source]["MaximumValue"][attr], attr, div);
                    break;
                case "barchart":
                    var dataAggregate = processBarData(data, source);
                    drawBars(dataAggregate, source, div, notes.showAvg, notes.showLabels, notes.annotation);
                    break;
                case "bubble":
                    var dataAggregate = processBarData(data, source);
                    drawBubbles(dataAggregate, source, div);
                    break;
                case "multistem":
                    var dataAggregate = processBarData(data, source);
                    drawMultiStem(dataAggregate, source, div);
                    break;
            }
        }

        var tooltipAttr;

        function showTooltip(attr, data, source) {
            tooltip.find(".prompt").hide();
            tooltip.find(".avg").show();
            tooltip.find(".attr").text(attr);
            
            var format = areaData[source]["AverageValue"][attr+"-FORMAT"],
                avg = areaData[source]["AverageValue"][attr],
                min = areaData[source]["MinimumValue"][attr],
                max = areaData[source]["MaximumValue"][attr];

            tooltipAttr = attr;

            var lis = d3.select("#tooltip ul").selectAll(".area").data(data);
            var entering = lis.enter().insert("li",".avg").attr("class","area");
            entering.append("span").attr("class","place");
            entering.append("span").attr("class","num");
            lis.exit().remove();

            lis.select(".place").text(function(d){ return d.place + ": "; });
            lis.select(".num").text(function(d){
                d.attr = attr;
                d.source = source;
                if (d.value == -9999) d.null = true;
                if (d.total) {
                    // calculating percentages for waffle types
                    d.value = formatNumber(" Percent ",d.data/d.total);
                } else {
                    d.value = formatNumber(format,d.data);
                }
                return (d.null) ? "No Data" : d.value;
            }).style("color",function(d){
                return (d.null) ? "#000" : colorData(d.data, avg, min, max);
            }).attr("class",function(d){
                return d.null ? "num n-d" : "num";
            });

            if (data[0].total) {
                var avgValue = formatNumber(" Percent ",avg/data[0].total);
            } else {
                var avgValue = formatNumber(format, avg);
            }
            tooltip.find(".avg span").text(avgValue);

            tooltip.find(".desc").text(areaData[source]["Description"][attr]);
        }

        function loadMap() {
            d3.json("geo_data/CPA_small.json",function(collection){
                mapData["CPA"] = collection;
                map.select("svg").attr("width","200").attr("height","300").append("g");
                loadMapData(collection, areaName, "CPA", null, null);
                processMapPlaces(map, null, [{"place":areaName,"data":null}], "CPA");
            });
        }

        function loadMapData(collection, places, source, placeData, attr) {
            map.select("#map-annotation").text(nameMapSource(source));
            var svg = map.select("svg g")
            var projection = d3.geo.albers().scale(25000)
                .translate([160, 140])
                .rotate([118.25,0])
                .center([0, 34.05]);

            var path = d3.geo.path().projection(projection);

            var paths = svg.selectAll('path')
                .data(collection.features)
            
            paths.enter().append('path').attr("stroke","#bbb").attr("fill","#fff");
            paths.exit().remove();

            paths.attr('d', path)
                .attr("fill",function(d){
                    var prop = getIdentifier(source);
                    if (places.indexOf(d.properties[prop]) != -1) {
                        if (!placeData || placeData[d.properties[prop]] == null)
                            return "yellow";
                        else
                            return colorData(placeData[d.properties[prop]], areaData[source]["AverageValue"][attr], areaData[source]["MinimumValue"][attr], areaData[source]["MaximumValue"][attr]);
                    }
                    return "#fff";
                }).on("click",function(d){
                    if (source == "CPA")
                        loadDataSource(d.properties.OBJECTID,0);
                });
            function getIdentifier(source) {
                switch (source) {
                    case "CPA":
                        return "NAME_ALF";
                        break;
                    case "CD": 
                        return "DIST";
                        break;
                    case "HD":
                        return "HD_NAME";
                        break;
                    case "PUMA":
                        return "NAMELSAD10";
                        break;
                    case "ZIP":
                        return "ZIPCODE";
                        break;
                }
            }
            function nameMapSource(source) {
                switch (source) {
                    case "CPA":
                        return "Community Planning Area";
                        break;
                    case "CD": 
                        return "Council District";
                        break;
                    case "HD":
                        return "HD";
                        break;
                    case "PUMA":
                        return "PUMA";
                        break;
                    case "ZIP":
                        return "Zipcode";
                        break;
                }
            }
        }

        function populatePopStats() {
            var data = areaData["CPA"][areaName];
            var pop = map.select("#pop-stats"),
                total = data["Total Population"];

            function textAndColor(div, attr, format, total) {
                var f = format ? format : data[attr+"-FORMAT"];
                pop.select(div).text(formatNumber(f, total ? data[attr]/total : data[attr]))
                    .style("color",colorData(data[attr], areaData["CPA"]["AverageValue"][attr], areaData["CPA"]["MinimumValue"][attr], areaData["CPA"]["MaximumValue"][attr]));
            }
            textAndColor(".pop-total span", "Total Population");
            textAndColor(".pop-density span", "Population per Square Mile");

            textAndColor(".pop-under-5 span", "Population Under Age 5 ", " Percent ", total);
            textAndColor(".pop-under-18 span", "Population Under Age 18", " Percent ", total);
            textAndColor(".pop-over-65 span", "Population Age 65 and Over", " Percent ", total);

            textAndColor(".pop-non-white span", "Percentage Non-White and Hispanic Population");
            textAndColor(".pop-isolated span", "Percentage of Linguistically-Isolated Households");

        }

        function processBarData(data, source) {
            var dataAggregate = [],
                areaList = [];
            for (area in areaData[source]) {
                if (specialRows.indexOf(area) == -1)
                    areaList.push(area);
            }
            areaList.sort();
            data.forEach(function(d){
                var aList = [];
                areaList.forEach(function(a){
                    aList.push({"place":a, 
                                "data":parseFloat(areaData[source][a][d]),
                                "format":areaData[source][a][d+"-FORMAT"]
                            });
                });
                var p = {"key":d,
                        "obj":aList,
                        "avg":parseFloat(areaData[source]["AverageValue"][d]),
                        "min":parseFloat(areaData[source]["MinimumValue"][d]),
                        "max":parseFloat(areaData[source]["MaximumValue"][d])};
                dataAggregate.push(p);
            });
            return dataAggregate;
        }

        function drawBubbles(data, source, wrapper) {
            data.forEach(function(datum, i){
                var chart = wrapper.append("div").attr("class","bubble b-"+i)
                                .style("width",Math.min((100/data.length), 33) + "%");
                chart.append("div").attr("class","bubble-wrapper");
                chart.append("div").attr("class","desc").text(areaData[source]["ShortLabel"][datum.key]);
            });
            updateBubbles(data, source, wrapper);
        }

        function updateBubbles(data, source, wrapper) {
            var smallBubbles = (data.length > 3 && data[0].obj.length > 2),
                bubbleWidth = smallBubbles ? 50 : 75,
                bubblePadding = 10;
                
            data.forEach(function(datum, i){
                if (smallBubbles) $(".b-"+i).addClass("small");
                else $(".b-"+i).removeClass("small");

                processMapPlaces(wrapper.select(".b-"+i), datum.key, datum.obj, source);

                var chart = wrapper.select(".b-"+i+" .bubble-wrapper")
                                .style("width",(bubbleWidth*datum.obj.length)+(bubblePadding*(datum.obj.length-1)) + "px");

                var bubbles = chart.selectAll(".bub").data(datum.obj);
                    bubbles.enter().append("div").attr("class","bub")
                    bubbles.exit().remove();

                bubbles.text(function(d){ return formatNumber(d.format, d.data); })
                    .style("background-color",function(d){
                        return colorData(d.data, datum.avg, datum.min, datum.max);
                    }).on("click",function(){ showTooltip(datum.key, datum.obj, source); });

                if (tooltipAttr == datum.key)
                    showTooltip(datum.key, datum.obj, source);
            })
        }

        function drawBars(data, source, wrapper, showAvg, showLabels, annotation) {
            if (data.length == 1) wrapper.style("width","50%").style("clear","none").style("float","left");

            data.forEach(function(datum, i){
                var chartWidth = (showAvg) ? 75 : (100/data.length);
                var chart = wrapper.append("div").attr("class","barchart c-"+i).style("width",chartWidth+"%"),
                    chartHeight = 120;
                var div = chart.append("div").attr("class","graph-object")
                            .style("height",chartHeight+"px");

                var barScale = d3.scale.linear().domain([datum.min,datum.max]).range([2,chartHeight]);

                div.append("div").attr("class","avg-line")
                    .style("top",function(d){ return chartHeight - barScale(datum.avg) + "px"; });

                div.append("div").attr("class","axis")
                    .style("width","100%").style("height","2px")
                    .style("top",chartHeight-2+"px");
                div.append("div").attr("class","axis")
                    .style("width","2px").style("height",chartHeight+"px");
                if (showAvg) {
                    chart.insert("h2",".graph-object").text(areaData[source]["ShortLabel"][datum.key]);
                    div.append("div").attr("class","avg-annotation")
                        .html("LA City average:<br>"+formatNumber(data[0].obj[0].format, datum.avg)+" "+(annotation ? annotation : ""))
                        .style("top",function(d){ return chartHeight - barScale(datum.avg) - 12 + "px"; });
                } else 
                    chart.append("div").attr("class","title").text(areaData[source]["ShortLabel"][datum.key]);

                if (showLabels) {
                    chart.append("div").attr("class","place-labels");
                }
            });
            updateBars(data, source, wrapper, showLabels);
        }

        function processMapPlaces(div, attr, placeData, source) {
            $(div[0]).hover(function(){
                places = [];
                data = {};
                placeData.forEach(function(p){
                    places.push(p.place);
                    data[p.place] = p.data;
                });
                if (source in mapData) 
                    loadMapData(mapData[source], places, source, data, attr);
                else
                    d3.json("geo_data/"+source+"_small.json",function(collection){
                        mapData[source] = collection;
                        loadMapData(collection, places, source, data, attr);
                    });
            });
        }

        function updateBars(data, source, wrapper, showLabels) {

            data.forEach(function(datum,i){
                var chart = wrapper.select(".c-"+i),
                    div = chart.select(".graph-object");

                processMapPlaces(chart, datum.key, datum.obj, source);

                var chartWidth = $(div[0]).width(),
                minPadding = 10,
                chartHeight = 120,
                barWidth = Math.min((chartWidth-minPadding*datum.obj.length)/datum.obj.length, 70),
                barPadding = Math.max((chartWidth-(datum.obj.length*barWidth))/datum.obj.length,minPadding);

                var barScale = d3.scale.linear().domain([datum.min,datum.max]).range([2,chartHeight]);

                var bars = div.selectAll(".bar").data(datum.obj);

                bars.enter()
                    .append("div")
                    .attr("class","bar")
                    .style("background-color","#fff")
                    .style("height","0px")
                    .style("top",chartHeight+"px");

                bars.exit()
                    .transition()
                    .duration(1000)
                    .style("height","0px")
                    .style("top",chartHeight+"px")
                    .remove();

                div.selectAll(".n-d").remove();

                bars.each(function(d,i){ 
                        if (d.data == -9999) {
                            d.null = true;
                            div.append("div").attr("class","n-d")
                                .style("left",i*(barWidth+barPadding) + barPadding/2 + "px")
                                .style("top",chartHeight - 17 + "px")
                                .text("n/d");
                        }
                    }).transition().duration(1000)
                    .style("width",barWidth+"px")
                    .style("height",function(d){ return d.null ? "0px" : barScale(d.data) + "px"; })
                    .style("left",function(d,i){ return i*(barWidth+barPadding) + barPadding/2 + "px"; })
                    .style("top",function(d){ return d.null ? chartHeight + "px" : chartHeight - barScale(d.data) + "px"; })
                    .style("background-color",function(d){ return colorData(d.data, datum.avg, datum.min, datum.max); });

                if (showLabels) {
                    var labels = wrapper.select(".place-labels").selectAll(".label").data(datum.obj);
                    labels.enter().append("div").attr("class","label").style("width",barWidth+"px");
                    labels.exit().remove();

                    labels.text(function(d){ return d.place; })
                        .style("left",function(d,i){ return i*(barWidth+barPadding) + barPadding/2 + "px"; })
                }

                chart.on("click",function(){ showTooltip(datum.key, datum.obj, source); });
                if (tooltipAttr == datum.key)
                    showTooltip(datum.key, datum.obj, source);
            });
        }

        function drawWaffle(data, descriptions, types, div) {
            var waffle = div.selectAll(".waffle")
                .data([types]).enter()
                .append("div").attr("class","waffle"),

                chartSize = 150,
                boxSize = chartSize/10;
            var wrapper = waffle.append("div").attr("class","box-wrapper")
                        .style("width",chartSize+"px").style("height",chartSize+"px");
            var key = waffle.append("ul").attr("class","boxes-key").style("left", chartSize + "px");

            var numBoxes = 0;

            for (var i = 0; i < 100; i++) {
                wrapper.append("div").attr("class","box")
                    .style("width",(boxSize - 2)+"px")
                    .style("height",(boxSize - 2)+"px")
                    .style("left",(numBoxes%10)*boxSize+"px")
                    .style("top",Math.floor(numBoxes/10)*boxSize + "px");
                numBoxes++;
            }

            types.forEach(function(attr,i){
                var li = key.append("li").attr("class","l-"+i);
                    li.append("div").attr("class","key-color").style("background-color",colors[i]);
                    li.append("span").attr("class","title").html(areaData["CPA"]["ShortLabel"][attr] + " <span class='num'></span>");
            });

            updateWaffle(data, descriptions, types, div);
        }

        function updateWaffle(data, descriptions, types, div) {
            processMapPlaces(div, null, [{"place":areaName,"data":null}], "CPA");

            var waffleTypes = [], totalValue = 0;
            types.forEach(function(type,i){
                waffleTypes[i] = { "title":type, "data":data[type] };
                totalValue += parseFloat(data[type]);
            });

            var numBoxes = 0;
            var key = div.select(".boxes-key");

            waffleTypes.forEach(function(land,j){
                var p = waffleTypes[j].data/totalValue*100;
                for (var i = 0; i < Math.round(p); i++) {
                    var box = $(div[0]).find(".box").eq(numBoxes)
                    box.css("background-color",colors[j])
                        .click(function(){
                            showTooltip(land.title, [{"place":areaName, "data":land.data, "total":totalValue}], "CPA");
                        });

                    numBoxes++;
                }
                key.select(".l-"+j)
                    .on("click",function(d){ 
                        showTooltip(land.title, [{"place":areaName, "data":land.data, "total":totalValue}], "CPA"); 
                    }).select(".num").text("(" + p.toFixed(0) + "%)");

                if (tooltipAttr == land.title)
                    showTooltip(land.title, [{"place":areaName, "data":land.data, "total":totalValue}], "CPA");
            });
        }

        function drawPie(value, avgValue, min, max, attr, div) {
            var pie = div.selectAll(".pie").data([value])
                        .enter().append("div").attr("class","pie"),
                pieSize = 160,
                circRadius = 60,
                svg = pie.append("svg").attr("width",pieSize).attr("height",pieSize);

            var avg = d3.svg.arc()
                .innerRadius(circRadius+10)
                .outerRadius(circRadius+16)
                .startAngle(0)
                .endAngle(avgValue * (2*Math.PI));

            svg.append("circle").attr("r",circRadius)
                .attr("cx",pieSize/2).attr("cy",pieSize/2)
                .attr("fill","#eee");

            svg.append("path").attr("class","pieData")
                .attr("transform","translate("+pieSize/2+","+pieSize/2+")");

            svg.append("path")
                .transition()
                .attr("d", avg)
                .attr("transform","translate("+pieSize/2+","+pieSize/2+")")
                .attr("fill","#55D440");

            pie.append("div").attr("class","pie-avg")
                .html("LA City<br> " + (avgValue*100).toFixed(0) + "%");

            updatePie(value, avgValue, min, max, attr, div);
        }

        function updatePie(value, avg, min, max, attr, div) {
            processMapPlaces(div, null, [{"place":areaName,"data":null}], "CPA");
            var circRadius = 60;
            var arc = d3.svg.arc()
                .innerRadius(0)
                .outerRadius(circRadius)
                .startAngle(0)
                .endAngle(value * 2*Math.PI);

            div.select(".pieData")
                .attr("d", arc)
                .attr("fill",colorData(value, avg, min, max));

            div.select("svg")
                .on("click",function(d){ showTooltip(attr, [{"place":areaName, "data":value}], "CPA"); })
            if (tooltipAttr == attr)
                showTooltip(attr, [{"place":areaName, "data":value}], "CPA");
        }

        function drawIsotype(valData, avgData, min, max, desc, attrs, div) {
            var isos = div.selectAll(".isotype")
                .data(attrs).enter()
                .append("div").attr("class","isotype");

            isos.each(function(attr, i){
                var iso = d3.select(this);
                personScale = d3.scale.linear().domain([0,1]).range([9,400]),
                imgWidth = 9;

                iso.append("div").attr("class","title").text(areaData["CPA"]["ShortLabel"][attr]);
                var graph = iso.append("div").attr("class","iso-graph");

                var val = graph.append("div").attr("class","iso-line value v-"+i);
                val.append("div").attr("class","title").text("here");
                val.append("div").attr("class","img");
                val.append("div").attr("class","textVal");

                var avg = graph.append("div").attr("class","iso-line average");
                avg.append("div").attr("class","title").text("city avg");
                avg.append("div").attr("class","img").style("width",(personScale(avgData[attr])) + "px");
                avg.append("div").attr("class","textVal").text(formatNumber(" Percent ",avgData[attr]));

            });
            updateIsotype(valData, min, max, div, attrs);
        }

        function updateIsotype(valData, min, max, div, attrs) {
            processMapPlaces(div, null, [{"place":areaName,"data":null}], "CPA");

            var isos = div.selectAll(".isotype").data(attrs)
                            .on("click",function(d){ showTooltip(d, [{"place":areaName, "data":valData[d]}], "CPA"); });

            attrs.forEach(function(attr,i){
                var personScale = d3.scale.linear().domain([0,1]).range([9,400]),
                bg = d3.scale.linear().domain([min[attr],max[attr]]).range([1,5]);

                var iso = isos.select(".v-"+i);

                iso.select(".img")
                    .attr("class",function(d){ return "img bg-"+Math.round(bg(valData[d])); })
                    .transition()
                    .duration(1000)
                    .style("width",function(d) { return personScale(valData[d]) + "px" });

                iso.select(".textVal")
                    .style("color",quartileColors[5 - Math.round(bg(valData[attr]))])
                    .text(formatNumber(" Percent ",valData[attr]));

                if (tooltipAttr == attr)
                    showTooltip(attr, [{"place":areaName, "data":valData[attr]}], "CPA");
            });
        }

        function drawMultiStem(data, source, div) {

            div.append("div").attr("class","areas").style("width",100/(data.length+1)+"%");

            var g = div.selectAll(".multi-graph")
                .data(data).enter()
                .append("div").attr("class",function(d,i){ return "multi-graph m-"+i })
                .style("width",100/(data.length+1)+"%");

            var divWidth = $(div[0]).find(".areas").width();

            g.append("div").attr("class","avg-label").text("avg");
            var l = g.append("div").attr("class","leafs");
                l.append("div").attr("class","stem").style("left",Math.floor(divWidth/2)+"px");
            g.append("div").attr("class","title").text(function(d){ return areaData[source]["ShortLabel"][d.key] });

            updateMultiStem(data, source, div);
        }

        function updateMultiStem(data, source, div) {

            var areas = div.select(".areas").selectAll(".area").data(data[0].obj)
            areas.enter().append("div").attr("class","area");
            areas.exit().remove();
            areas.text(function(d) { return d.place; })
                .style("width",(data.length+1)*100 + "%");

            data.forEach(function(datum,i){
                var wrapper = div.select(".m-"+i);
                var graph = wrapper.select(".leafs");

                processMapPlaces(wrapper, datum.key, datum.obj, source);

                var divWidth = $(graph[0]).width(),
                    leafMaxWidth = divWidth/2,
                    leafHeight = 25;

                var graphHeight = datum.obj.length*leafHeight
                graph.style("height", graphHeight+"px");

                var barScale = d3.scale.linear().domain([datum.min,datum.max]).range([2,leafMaxWidth]);

                var leafs = graph.selectAll(".leaf").data(datum.obj);
                leafs.enter().append("div").attr("class","leaf")
                    .style("background-color","#fff");
                leafs.exit().remove();

                graph.selectAll(".n-d").remove();

                leafs.each(function(d,i){
                    if (d.data == -9999) {
                        d.null = true;
                        graph.append("div").attr("class","n-d")
                            .style("left",divWidth/2 + 5 + "px")
                            .style("top",i*leafHeight + 7 + "px")
                            .text("no data");
                    }
                }).transition().duration(1000)
                .style("width",function(d){
                    d.diff = Math.floor(barScale(datum.avg) - barScale(d.data));
                    return d.null ? "0px" : Math.abs(d.diff) + "px";
                }).style("background-color",function(d){
                    return colorData(d.data, datum.avg, datum.min, datum.max);
                }).style("left",function(d){
                    var neg = (d.diff < 0) ? true : false;
                    return d.null ? "0px" : divWidth/2 + (neg ? 2 : -d.diff) + "px";  
                }).style("top",function(d,i){ return i*leafHeight + 5 + "px"});

                wrapper.on("click",function(d){ showTooltip(datum.key, datum.obj, source); });
                if (tooltipAttr == datum.key)
                    showTooltip(datum.key, datum.obj, source);
            });
        }

        function drawStemAndLeaf(attrs, val, avg, min, max, div) {
            var stem = div.selectAll(".stem-and-leaf")
                        .data([val]).enter()
                        .append("div").attr("class","stem-and-leaf");

            var svgWidth = 100,
                boxPadding = 5,
                leafHeight = 30,
                svgWrapper = stem.append("div").attr("class","wrapper")
                svg = svgWrapper.append("svg").attr("width",svgWidth).attr("height",attrs.length*leafHeight);

            svg.append("rect").attr("x",svgWidth/2)
                .attr("width",2).attr("height",attrs.length*leafHeight)
                .attr("fill","#00C04A");

            svgWrapper.append("div").attr("class","avg-title").text("avg");
                
            attrs.forEach(function(attr,i){
                var leaf = stem.append("div").attr("class","leaf");

                leaf.append("div").attr("class","title t-"+i);

                svg.append("rect").attr("class","leaf-"+i)
                    .attr("y",i*leafHeight + boxPadding)
                    .attr("height",(leafHeight - 2*boxPadding));
            });

            updateStemAndLeaf(attrs, val, avg, min, max, div);
        }

        function updateStemAndLeaf(attrs, val, avg, min, max, div) {
            processMapPlaces(div, null, [{"place":areaName,"data":null}], "CPA");

            var stem = div.selectAll(".stem-and-leaf").data([val]);
            attrs.forEach(function(attr,i){
                
                var format = val[attr+"-FORMAT"];
                var textDisplay = formatNumber(format, val[attr]);
                stem.select(".t-"+i).html("<span>" +textDisplay +"</span> "+ areaData["CPA"]["ShortLabel"][attr] )
                    .on("click",function(d){ showTooltip(attr, [{"place":areaName, "data":val[attr]}], "CPA"); });

                var leafMaxWidth = 50,
                    svgWidth = 100,
                    leafHeight = 30;

                var barScale = d3.scale.linear().domain([min[attr],max[attr]]).range([2,leafMaxWidth]);

                var diff = barScale(avg[attr])-barScale(val[attr]),
                        neg = (diff < 0) ? true : false;

                div.select(".leaf-"+i)
                    .transition().duration(1000)
                    .attr("x",(svgWidth/2 + (neg ? 2 : -diff)))
                    .attr("width",Math.abs(diff))
                    .attr("fill",colorData(val[attr], avg[attr], min[attr], max[attr]));

                div.select(".leaf-"+i)
                    .on("click",function(d){ showTooltip(attr, [{"place":areaName, "data":val[attr]}], "CPA"); });
                if (tooltipAttr == attr)
                    showTooltip(attr, [{"place":areaName, "data":val[attr]}], "CPA");
            });
        }

        function drawThermometer(attr, val, min, max, format, div, showNumber, wordDesc) {
            var therm = div.selectAll(".thermometer")
                .data([val]).enter()
                .append("div").attr("class",wordDesc ? "thermometer words" : "thermometer");

            var thermHeight = 15,
                thermWidth = 200,
                thermWrapper = therm.append("div").attr("class","therm-wrapper")
                                    .style("height",thermHeight+"px").style("width",thermWidth+"px"),
                valueWrapper = therm.append("div").attr("class","value-wrapper")
                                    .style("width",thermWidth+"px").style("height", thermHeight+"px");

            for (var i = 0; i < 5; i++) {
                thermWrapper.append("div").attr("class","therm-background")
                    .style("background-color",quartileColors[4-i])
                    .style("height",thermHeight + "px")
                    .style("width",thermWidth/5 + "px")
                    .style("left",(thermWidth/5)*i + "px");
            }

            var textMax = valueWrapper.append("div").attr("class","scale max")
                            .text(wordDesc ? "most" : formatNumber(format, max));
            var textMin = valueWrapper.append("div").attr("class","scale min")
                            .text(wordDesc ? "least" : formatNumber(format, min));

            var circWrapper = valueWrapper.append("div")
                .attr("class","circle-wrapper")
                .style("width",thermHeight+"px");
            circWrapper.append("div").attr("class","circle")
                .style("width",thermHeight+"px")
                .style("height",thermHeight+"px");

            if (showNumber) {
                therm.append("div").attr("class","big-number")
            } else {
                circWrapper.append("div").attr("class","circle-label");
            }

            updateThermometer(attr, val, min, max, format, div, showNumber);
        }

        function updateThermometer(attr, val, min, max, format, div, showNumber) {
            processMapPlaces(div, null, [{"place":areaName,"data":null}], "CPA");

            var thermHeight = 15,
                thermWidth = 200;
            div.selectAll(".thermometer").data([val])
                .on("click",function(d){ showTooltip(attr, [{"place":areaName, "data":val}], "CPA"); });

            if (tooltipAttr == attr)
                showTooltip(attr, [{"place":areaName, "data":val}], "CPA");

            var posScale = d3.scale.linear().domain([max,min]).range([0,thermWidth-thermHeight]);
            div.select(".circle-wrapper")
                .transition()
                .duration(1000)
                .style("margin-right",posScale(val)+"px");

            val = formatNumber(format, val);

            if (showNumber)
                div.select(".big-number").text(val);
            else
                div.select(".circle-label").text(val);
        }

        function colorData(val, avg, min, max) {
            if (val == -9999) return "#fff";
            if (val > avg) {
                var colorScale = d3.scale.linear().domain([avg,max]).range(["#D4DCCF","#F07221"]);
            } else {
                var colorScale = d3.scale.linear().domain([min,avg]).range(["#55A4DB","#D4DCCF"]);
            }
            return colorScale(val);
        }

        function formatNumber(format, value) {
            if (format == " Integer ")
                value = parseInt(value).toFixed(0).replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
            else if (format == " Dollar ") {
                if (value.match(/\$/)) return value;
                value = parseInt(value).toFixed(0);
                value = "$"+value.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
            } else if (format == " Percent ")
                value = (value*100).toFixed(0)+"%";
            return value;
        }

    </script>
</html>
