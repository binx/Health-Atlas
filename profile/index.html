<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="lib/jquery.min.js" charset="utf-8"></script>
        <script type="text/javascript" src="lib/d3.v3.min.js" charset="utf-8"></script>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <div id="map">
            <h1></h1>
            <svg></svg>
        </div>
        <div id="graphs">
        </div>
        <div id="tooltip">
                <div class="place"></div>
                <div class="data"></div>
            </div>
    </body>
    <script type="text/javascript">
        var specialRows = ["DataSource","Description","MinimumValue","MaximumValue","AverageValue","GeographicScale","AveValueGeo"];
        var colors = ["yellow","orange","pink","green","purple","red"];
        var graphs = d3.select("#graphs"),
            map = d3.select("#map"),
            tooltip = d3.select("#tooltip"),
            areaName,
            areaData = {},
            mapData = {};

        var layoutData;

        d3.json("data/profile.json",function(json){
            layoutData = json.data;
            json.data.forEach(function(v){
                var div = graphs.append("div").attr("class","section");
                div.append("h1").text(v.key);

                v.obj.forEach(function(w){
                    var subdiv = div.append("div").attr("class","graph graph-"+w.obj.type).data([w.obj]);
                    if (w.key) subdiv.append("h2").text(w.key);
                    // appendGraph(w.obj.source, w.obj.type, w.obj.data, subdiv, (w.obj.notes ? w.obj.notes : ""));
                });
            });
            loadCPA(1);
        });

        function loadCPA(id) {
            d3.csv("data/"+id+"-CPA.csv",function(csv){
                areaName = csv[0]["Area Name"];
                areaData["CPA"] = {};

                csv.forEach(function(v,i){
                    if (v["Area Name"] != "") {
                        areaData["CPA"][v["Area Name"]] = v;
                    }
                });
                loadCD(id);
            });            
        }
        function loadCD(id) {
            d3.csv("data/"+id+"-CD.csv",function(csv){
                areaData["CD"] = {};
                csv.forEach(function(v,i){
                    if (v["Area Name"] != "") {
                        if (v["Specific area"] != "")
                            areaData["CD"][v["Specific area"]] = v;
                        else
                            areaData["CD"][v["Area Name"]] = v;
                    }
                });
                loadHD(id);
            });
        }
        function loadHD(id) {
            d3.csv("data/"+id+"-HD.csv",function(csv){
                areaData["HD"] = {};
                csv.forEach(function(v,i){
                    if (v["Area Name"] != "") {
                        if (v["Specific area"] != "")
                            areaData["HD"][v["Specific area"]] = v;
                        else
                            areaData["HD"][v["Area Name"]] = v;
                    }
                });
                loadPUMA(id);
            });            
        }
        function loadPUMA(id) {
            areaData["PUMA"] = {};
            d3.csv("data/"+id+"-PUMA.csv",function(csv){
                csv.forEach(function(v,i){
                    if (v["Area Name"] != "") {
                        if (v["Specific area"] != "")
                            areaData["PUMA"][v["Specific area"]] = v;
                        else
                            areaData["PUMA"][v["Area Name"]] = v;
                    }
                });
                loadZIP(id);
            });            
        }
        function loadZIP(id) {
            areaData["ZIP"] = {};
            d3.csv("data/"+id+"-ZIP.csv",function(csv){
                csv.forEach(function(v,i){
                    if (v["Area Name"] != "") {
                        if (v["Specific area"] != "")
                            areaData["ZIP"][v["Specific area"]] = v;
                        else
                            areaData["ZIP"][v["Area Name"]] = v;
                    }
                });
                showData();
            });            
        }

        var loaded = false;

        function showData() {
            map.select("h1").text(areaName);

            if (loaded) {
                graphs.selectAll(".graph").each(function(d){ 
                    var source = d.source, 
                        type = d.type, 
                        div = d3.select(this), 
                        notes = (d.notes) ? d.notes : "";
                    if (d.type == "thermometer") {
                        var attr = d.data[0];
                        updateThermometer(attr, areaData[source][areaName][attr], areaData[source]["MinimumValue"][attr], areaData[source]["MaximumValue"][attr], areaData[source][areaName][attr+"-FORMAT"], div, notes.number);
                    } else if (d.type == "pie") {
                        updatePie(areaData[source][areaName][d.data[0]], d.data[0], div);
                    } else if (d.type == "stemandleaf") {
                        updateStemAndLeaf(d.data,areaData[source][areaName],areaData[source]["AverageValue"],areaData[source]["MinimumValue"],areaData[source]["MaximumValue"], div);
                    } else if (d.type == "isotope") {
                        updateIsotope(areaData[source][areaName],areaData[source]["MinimumValue"],areaData[source]["MaximumValue"], div, d.data);
                    } else if (d.type == "waffle")
                        updateWaffle(areaData[source][areaName], areaData[source]["Description"], d.data, div);
                    else {
                        var dataAggregate = processBarData(d.data, source)
                        updateBars(dataAggregate, source, div);
                    }
                });
            } else {
                graphs.selectAll(".graph").each(function(d){ 
                    appendGraph(d.source, d.type, d.data, d3.select(this), (d.notes ? d.notes : ""));
                });
            }

            loaded = true;
            
            // layoutData.forEach(function(w){
            //     var subdiv = div.append("div").attr("class","graph-"+w.obj.type);
            //     if (w.key) subdiv.append("h2").text(w.key);
            //     appendGraph(w.obj.source, w.obj.type, w.obj.data, subdiv, (w.obj.notes ? w.obj.notes : ""));
            // });

            loadMap();
        }

        function appendGraph(source, type, data, div, notes) {
            if (type == "waffle") {
                drawWaffle(areaData[source][areaName], areaData[source]["Description"], data, div);
            }
            if (type == "isotope") {
                drawIsotope(areaData[source][areaName],areaData[source]["AverageValue"],areaData[source]["MinimumValue"],areaData[source]["MaximumValue"],areaData[source]["Description"], data, div);
            }
            if (type == "thermometer") {
                var attr = data[0];
                drawThermometer(attr, areaData[source][areaName][attr], areaData[source]["MinimumValue"][attr], areaData[source]["MaximumValue"][attr], areaData[source][areaName][attr+"-FORMAT"], div, notes.number);
            }
            if (type == "stemandleaf") {
                drawStemAndLeaf(data,areaData[source][areaName],areaData[source]["AverageValue"],areaData[source]["MinimumValue"],areaData[source]["MaximumValue"], div);
            }
            if (type == "pie") {
                var attr = data[0];
                drawPie(areaData[source][areaName][attr], areaData[source]["AverageValue"][attr], attr, div);
            }
            if (type == "barchart") {
                var dataAggregate = processBarData(data, source)
                drawBars(dataAggregate, source, div);
            }
        }

        function showTooltip(data, place, attr, source) {
            tooltip.select(".place").text(source + ": " + place);
            tooltip.select(".data").html(attr + ": <span>" + data+"</span>");
        }
        function positionTooltip(elem, pos) {
            var m = d3.mouse(elem);

            tooltip.style("left",(pos.left + m[0])+"px")
                .style("top",(pos.top + m[1])+"px")
                .style("display","block");
        }
        function hideTooltip() {
            tooltip.style("display","none");
        }

        function loadMap() {
            d3.json("data/map.json",function(collection){
                mapData["CPA"] = collection;
                map.select("svg").attr("width","200").attr("height","300").append("g");
                loadMapData(collection, areaName, "CPA");
            });
        }

        function loadMapData(collection, places, source) {
            var svg = map.select("svg g")
            var projection = d3.geo.albers().scale(25000)
                .translate([160, 140])
                .rotate([118.25,0])
                .center([0, 34.05]);

            var path = d3.geo.path().projection(projection);

            var paths = svg.selectAll('path')
                .data(collection.features)
            
            paths.enter().append('path').attr("fill","#fff");
            paths.exit().remove();

            paths.attr('d', path)
                .attr("fill",function(d){
                    var prop = getIdentifier(source);
                    if (places.indexOf(d.properties[prop]) != -1)
                        return "yellow";
                    return "#fff";
                }).attr("stroke",function(d){
                    if (d.properties.NAME_ALF == areaName)
                        return "black";
                    return "#aaa";
                }).on("click",function(d){
                    loadCPA(d.properties.OBJECTID);
                });
            function getIdentifier(source) {
                switch (source) {
                    case "CPA":
                        return "NAME_ALF";
                        break;
                    case "CD": 
                        return "DIST";
                        break;
                    case "HD":
                        return "Area";
                        break;
                    case "PUMA":
                        return "NAMELSAD10";
                        break;
                    case "ZIP":
                        return "ZIPCODE";
                        break;
                }
            }
        }

        function processBarData(data, source) {
            var dataAggregate = [],
                areaList = [];
            for (area in areaData[source]) {
                if (specialRows.indexOf(area) == -1)
                    areaList.push(area);
            }
            areaList.sort();
            data.forEach(function(d){
                var aList = [];
                areaList.forEach(function(a){
                    aList.push({"place":a, 
                                "data":parseFloat(areaData[source][a][d])});
                })
                var p = {"key":d,
                        "obj":aList,
                        "avg":parseFloat(areaData[source]["AverageValue"][d]),
                        "min":parseFloat(areaData[source]["MinimumValue"][d]),
                        "max":parseFloat(areaData[source]["MaximumValue"][d])};
                dataAggregate.push(p);
            });
            return dataAggregate;
        }

        function drawBars(data, source, div) {
            if (data.length == 1) div.style("width","50%").style("clear","none").style("float","left");

            data.forEach(function(datum, i){
                var chart = div.append("div").attr("class","barchart c-"+i).style("width",(100/data.length)+"%"),
                    chartHeight = 120;
                var svg = chart.append("svg").attr("width","90%").attr("height",chartHeight+"px");

                svg.append("rect").attr("class","avg-line")
                    .attr("width","100%").attr("height",2)
                    .attr("fill","green");

                svg.append("rect").attr("class","axis")
                    .attr("width","100%").attr("height",2)
                    .attr("y",chartHeight-2);
                svg.append("rect").attr("class","axis")
                    .attr("width",2).attr("height","100%");

                chart.append("div").attr("class","title").text(datum.key)
            });
            updateBars(data, source, div);
        }

        function updateBars(data, source, div) {

            $(div[0]).hover(function(){
                places = [];
                data[0].obj.forEach(function(p){
                    if (source == "CD")
                        places.push(p.place.substr(-1));
                    else
                        places.push(p.place);
                });
                if (source in mapData) loadMapData(mapData[source], places, source);
                else
                    d3.json("data/"+source+"_small.json",function(collection){
                        mapData[source] = collection;
                        loadMapData(collection, places, source);
                    });
            },function(){
                loadMapData(mapData["CPA"], areaName, "CPA");
            });

            data.forEach(function(datum,i){
                var chart = div.select(".c-"+i),
                    svg = chart.select("svg");
                var chartWidth = $(svg[0]).width(),
                minPadding = 10,
                chartHeight = 120,
                barWidth = Math.min((chartWidth-minPadding*datum.obj.length)/datum.obj.length, 70),
                barPadding = Math.max((chartWidth-(datum.obj.length*barWidth))/datum.obj.length,minPadding);

                var barScale = d3.scale.linear().domain([datum.min,datum.max]).range([2,chartHeight-2]),
                    colorScale = d3.scale.linear().domain([datum.min,datum.max]).range(["#EC8E4F","#64E0E5"]);

                svg.select(".avg-line")
                    .attr("y",barScale(datum.avg));

                var bars = svg.selectAll("rect.bar").data(datum.obj);

                bars.enter().append("rect").attr("class","bar").attr("fill","#fff").attr("height",0).attr("y",chartHeight);
                bars.exit()
                    .transition()
                    .duration(1000)
                    .attr("height",0)
                    .attr("y",chartHeight)
                    .remove();

                bars.transition().duration(1000)
                    .attr("width",barWidth)
                    .attr("height",function(d){ return barScale(d.data); })
                    .attr("x",function(d,i){ return i*(barWidth+barPadding) + barPadding/2; })
                    .attr("y",function(d){ return chartHeight - barScale(d.data); })
                    .attr("fill",function(d){ return colorScale(d.data); });

                var pos = $(svg[0]).offset();

                bars.on("mouseenter",function(d){ showTooltip(d.data, d.place, datum.key, source); })
                    .on("mousemove",function(d){ positionTooltip(this, pos); })
                    .on("mouseout",function(d){ hideTooltip(); });
            });
        }

        function drawWaffle(data, descriptions, types, div) {
            var waffle = div.selectAll(".waffle")
                .data([types]).enter()
                .append("div").attr("class","waffle"),

                chartSize = 100,
                boxSize = chartSize/10;
            var wrapper = waffle.append("div").attr("class","box-wrapper")
                        .style("width",chartSize+"px").style("height",chartSize+"px");
            var key = waffle.append("ul").attr("class","boxes-key").style("left", chartSize + "px");

            var numBoxes = 0;

            for (var i = 0; i < 100; i++) {
                wrapper.append("div").attr("class","box")
                    .style("width",(boxSize - 2)+"px")
                    .style("height",(boxSize - 2)+"px")
                    .style("left",(numBoxes%10)*boxSize+"px")
                    .style("top",Math.floor(numBoxes/10)*boxSize + "px");
                numBoxes++;
            }

            types.forEach(function(land,i){
                var li = key.append("li").attr("class","l-"+i);
                    li.append("div").attr("class","key-color").style("background-color",colors[i]);
                    li.append("span").html(land + " <span class='num'></span>");
            });

            updateWaffle(data, descriptions, types, div);
        }

        function updateWaffle(data, descriptions, types, div) {

            var waffleTypes = [], totalValue = 0;
            types.forEach(function(type,i){
                waffleTypes[i] = { "title":type, "data":data[type] };
                totalValue += parseFloat(data[type]);
            });

            var numBoxes = 0;
            var key = div.select(".boxes-key");

            waffleTypes.forEach(function(land,j){
                var p = waffleTypes[j].data/totalValue*100;
                for (var i = 0; i < Math.round(p); i++) {
                    var box = $(div[0]).find(".box").eq(numBoxes)
                    box.css("background-color",colors[j]);
                    var pos = box.offset();

                    d3.select(box[0])
                        .on("mouseenter",function(d){ showTooltip(waffleTypes[j].data, areaName, land.title, "CPA"); })
                        .on("mousemove",function(d){ positionTooltip(this, pos); })
                        .on("mouseout",function(d){ hideTooltip(); });

                    numBoxes++;
                }
                key.select(".l-"+j+" .num").text("(" + p.toFixed(1) + "%)");
            });
        }

        function drawPie(value, avgValue, attr, div) {
            var pie = div.selectAll(".pie").data([value])
                        .enter().append("div").attr("class","pie"),
                pieSize = 120,
                svg = pie.append("svg").attr("width",pieSize).attr("height",pieSize);

            var avg = d3.svg.arc()
                .innerRadius(50)
                .outerRadius(53)
                .startAngle(0)
                .endAngle(avgValue * (2*Math.PI));

            svg.append("circle").attr("r",40)
                .attr("cx",pieSize/2).attr("cy",pieSize/2)
                .attr("fill","#ddd");

            svg.append("path").attr("class","pieData")
                .attr("transform","translate("+pieSize/2+","+pieSize/2+")")
                .attr("fill","lightBlue");;

            svg.append("path")
                .transition()
                .attr("d", avg)
                .attr("transform","translate("+pieSize/2+","+pieSize/2+")")
                .attr("fill","black");

            pie.append("div").attr("class","pie-avg")
                .html("LA County<br> " + (avgValue*100).toFixed(0) + "%");

            updatePie(value, attr, div);
        }

        function updatePie(value, attr, div) {
            var arc = d3.svg.arc()
                .innerRadius(00)
                .outerRadius(40)
                .startAngle(0)
                .endAngle(value * 2*Math.PI);

            div.select(".pieData")
                .attr("d", arc);

            var pos = $(div[0]).find("svg").offset();

            div.select("svg")
                .on("mouseenter",function(d){ showTooltip(value, areaName, attr, "CPA"); })
                .on("mousemove",function(d){ positionTooltip(this, pos); })
                .on("mouseout",function(d){ hideTooltip(); });
        }

        function drawIsotope(valData, avgData, min, max, desc, attrs, div) {
            var isos = div.selectAll(".isotope")
                .data(attrs).enter()
                .append("div").attr("class","isotope");

            isos.each(function(attr, i){
                var iso = d3.select(this);
                personScale = d3.scale.linear().domain([min[attr],max[attr]]).range([9,400]),
                imgWidth = 9;

                iso.append("div").attr("class","title").text(attr);
                var graph = iso.append("div").attr("class","iso-graph");

                var val = graph.append("div").attr("class","iso-line value v-"+i);
                val.append("div").attr("class","title").text("here");
                val.append("div").attr("class","img");

                var avg = graph.append("div").attr("class","iso-line average");
                avg.append("div").attr("class","title").text("city avg");
                avg.append("div").attr("class","img").style("width",(personScale(avgData[attr])) + "px");

            });
            updateIsotope(valData, min, max, div, attrs);
        }

        function updateIsotope(valData, min, max, div, attrs) {
            var isos = div.selectAll(".isotope").data(attrs);

            attrs.forEach(function(attr,i){
                var personScale = d3.scale.linear().domain([min[attr],max[attr]]).range([9,400]),
                bg = d3.scale.linear().domain([min[attr],max[attr]]).range([1,5]);

                isos.select(".v-"+i+" .img")
                    .attr("class",function(d){ return "img bg-"+Math.round(bg(valData[d])); })
                    .transition()
                    .duration(1000)
                    .style("width",function(d) { return personScale(valData[d]) + "px" });

                var pos = $(div[0]).find(".v-"+i).offset();

                div.select(".v-"+i)
                    .on("mouseenter",function(d){ showTooltip(valData[attr], areaName, attr, "CPA"); })
                    .on("mousemove",function(d){ positionTooltip(this, pos); })
                    .on("mouseout",function(d){ hideTooltip(); });
            });
        }

        function drawStemAndLeaf(attrs, val, avg, min, max, div) {
            var stem = div.selectAll(".stem-and-leaf")
                        .data([val]).enter()
                        .append("div").attr("class","stem-and-leaf");
            var svgWidth = 100,
                boxPadding = 5,
                leafHeight = 30,
                svgWrapper = stem.append("div").attr("class","wrapper")
                svg = svgWrapper.append("svg").attr("width",svgWidth).attr("height",attrs.length*leafHeight);

            svg.append("rect").attr("x",svgWidth/2).attr("width",2).attr("height",attrs.length*leafHeight);

            svgWrapper.append("div").attr("class","avg-title").text("avg");
                
            attrs.forEach(function(attr,i){
                var leaf = stem.append("div").attr("class","leaf");

                leaf.append("div").attr("class","title t-"+i);

                svg.append("rect").attr("class","leaf-"+i)
                    .attr("y",i*leafHeight + boxPadding)
                    .attr("height",(leafHeight - 2*boxPadding));
            });

            svg.append("rect").attr("x",svgWidth/2).attr("width",2).attr("height",attrs.length*leafHeight);

            updateStemAndLeaf(attrs, val, avg, min, max, div);
        }

        function updateStemAndLeaf(attrs, val, avg, min, max, div) {
            var leafMaxWidth = 50,
                svgWidth = 100,
                leafHeight = 30;
            var stem = div.selectAll(".stem-and-leaf").data([val]);
            attrs.forEach(function(attr,i){
                var barScale = d3.scale.linear().domain([min[attr],max[attr]]).range([2,leafMaxWidth]);
                var colorScale = d3.scale.linear().domain([min[attr],max[attr]]).range(["#EC8E4F","#64E0E5"]);

                var format = val[attr+"-FORMAT"];
                var textDisplay = formatNumber(format, val[attr]);
                stem.select(".t-"+i).html(attr + " <span>" + textDisplay + "</span>");

                var diff = barScale(avg[attr])-barScale(val[attr]),
                    neg = (diff < 0) ? true : false;

                stem.select("svg .leaf-"+i)
                    .transition()
                    .duration(1000)
                    .attr("x",(svgWidth/2 + (neg ? 2 : -diff)))
                    .attr("width",Math.abs(diff))
                    .attr("fill",colorScale(val[attr]));

                var pos = $(stem[0]).find(".leaf-"+i).offset();

                div.select(".leaf-"+i)
                    .on("mouseenter",function(d){ showTooltip(val[attr], areaName, attr, "CPA"); })
                    .on("mousemove",function(d){ positionTooltip(this, pos); })
                    .on("mouseout",function(d){ hideTooltip(); });
            });
        }

        function drawThermometer(attr, val, min, max, format, div, showNumber) {
            var therm = div.selectAll(".thermometer")
                .data(["ok"]).enter()
                .append("div").attr("class","thermometer");

            var thermHeight = 200,
                thermWidth = 15,
                thermWrapper = therm.append("div").attr("class","therm-wrapper")
                                    .style("height",thermHeight+"px").style("width",thermWidth+"px"),
                valueWrapper = therm.append("div").attr("class","value-wrapper")
                                    .style("height",thermHeight+"px"),
                colorScale = d3.scale.linear().domain([0,5]).range(["#EC8E4F","#64E0E5"]);

            for (var i = 0; i < 5; i++) {
                thermWrapper.append("div").attr("class","therm-background")
                    .style("background-color",colorScale(i))
                    .style("width",thermWidth + "px")
                    .style("height",thermHeight/5 + "px")
                    .style("top",(thermHeight/5)*i + "px");
            }

            valueWrapper.append("div").attr("class","scale max").text(formatNumber(format, max));
            valueWrapper.append("div").attr("class","scale min").text(formatNumber(format, min));

            var circWrapper = valueWrapper.append("div")
                .attr("class","circle-wrapper")
                .style("width",thermWidth+"px");
            circWrapper.append("div").attr("class","circle")
                .style("width",thermWidth+"px")
                .style("height",thermWidth+"px");

            if (showNumber) {
                therm.append("div").attr("class","big-number")
            } else {
                circWrapper.append("div").attr("class","circle-label");
            }

            updateThermometer(attr, val, min, max, format, div, showNumber);
        }

        function updateThermometer(attr, val, min, max, format, div, showNumber) {
            var thermHeight = 200,
                thermWidth = 15;
            div.selectAll(".thermometer").data([val]);

            var posScale = d3.scale.linear().domain([max,min]).range([0,thermHeight-thermWidth]);
            div.select(".circle-wrapper")
                .transition()
                .duration(1000)
                .style("margin-top",posScale(val)+"px");

            var pos = $(div[0]).find(".thermometer").offset();

            div.select(".thermometer")
                .on("mouseenter",function(d){ showTooltip(val, areaName, attr, "CPA"); })
                .on("mousemove",function(d){ positionTooltip(this, pos); })
                .on("mouseout",function(d){ hideTooltip(); });

            val = formatNumber(format, val);

            if (showNumber) {
                div.select(".big-number").text(val);
            } else {
                div.select(".circle-label")
                    .text(val)
                    .transition()
                    .style("margin","-"+thermWidth+"px 0 0 "+(thermWidth+5)+"px");
            }
        }

        function formatNumber(format, value) {
            if (format == " Integer ")
                value = parseInt(value).toFixed(0);
            else if (format == " Dollar ") {
                value = parseInt(value).toFixed(0);
                value = "$"+value.substring(0,value.length-3)+","+value.substring(2,value.length);
            } else if (format == " Percent ")
                value = (value*100).toFixed(1)+"%";
            return value;
        }

    </script>
</html>
